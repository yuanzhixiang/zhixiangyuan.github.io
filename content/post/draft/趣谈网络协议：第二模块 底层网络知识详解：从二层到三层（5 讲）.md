---
title: "趣谈网络协议：第二模块 底层网络知识详解：从二层到三层（5 讲）"
date: 2019-07-07T21:25:03+08:00
keywords: []
description: ""
tags: [
    "极客时间"
]
categories: [
    "天凉好个秋"
]
autoCollapseToc: true
author: "yuanzx"
draft: true
---

## 第 5 讲 | 从物理层到 MAC 层：如何在宿舍里自己组网玩联机游戏？

### 第一层（物理层）

使用电脑连电脑的网线，由于水晶头的第 1、2 和第 3、6 脚起收发信号的作用，故将一端的 1 号和 3 号线、2 号和 6 号线互换一下位置，就能在物理层实现一端发送信号，另一端接收信号了。然后在两台电脑上配置 IP 地址、子网掩码和默认网关，将一台配置成 192.168.0.1/24，另一个配置成 192.168.0.2/24 就行了。（这里有个问题，网关改配成多少？）

如果现在需要三台电脑连在一起，（如果不使用交换机）可以使用集线器，这种设备有多个口，可以讲宿舍里面的多台电脑连接起来，但是和交换机不一样，集线器没有大脑，它完全在物理层工作，它会将自己收到的每一个字节都复制到其他的端口上去。这是第一层物理层的联通方案

### 第二层（数据链路层）

数据链路层主要解决三个问题

1. 这个包是发给谁的？
2. 发包的顺序，谁应该先发，谁应该后发？
3. 怎么检测发送的时候是否出现了错误？

MAC：Medium Access Control

先看一下第二层的网络包的格式

![网络包的格式](/media/book_abstract/14.jpg)

先是目标 MAC 地址，然后是源 MAC 地址，接下来是类型，大部分的类型是 IP 数据包，然后 IP 里面包含 TCP、UDP 以及 HTTP 等，这里面都是层层封装的。对于以太网最后面是 CRC，也就是循环冗余检验，通过 XOR 异或的算法，来计算整个包是否在发送的过程中出现了错误，主要解决第三个问题。

#### 关于第一个问题包发给谁的

这个问题通过 MAC 地址来控制

#### 关于第二个问题发送的顺序

解决这个问题的规则，学名叫做**多路访问**，有很多算法可以解决这个问题，如果如下的三种方式：

1. 分多个车道，每个车一个车道，你走你的，我走我的。这在计算机网络里叫作信道划分
2. 今天单号出行，明天双号出行，轮着来。这在计算机网络里叫作轮流协议
3. 不管三七二十一，有事儿先出门，发现特堵，就回去，错过高峰再出来，我们叫做随机接入协议，著名的以太网用的就是这个方式。

#### 关于第三个问题如何判断发送时候是否有错误

这个地方就是使用数据包最后的 CRC 进行校验，然后就能判断出来是在传输的过程中发生了错误。

#### 如果知道 IP 地址，不知道 MAC 通过什么来获取 MAC

通过 ARP 类型的广播包来获取 MAC 地址

![ARP 数据包类型](/media/book_abstract/15.jpg)

ARP 获取到 MAC 地址进行缓存，每过一段时间就会过期。

### 局域网

用上述的方式，就能够组建起一个能够用的局域网了，但是如果仅仅使用集线器，这玩意儿无脑将数据复制到所有的端口上，那么会存在资源浪费的问题。这个时候交换机就比集线器有优势了，它会记住哪个口对应哪个 MAC，那么在初始没有记录的时候会采用和集线器同样的工作方式，当收到第一个包的时候他就知道这个口对应哪个 MAC 地址了，那么将来就会将对应的数据传到这个口上，降低资源浪费的问题。而交换机学习的结果就是转发表，这个表也是有一个过期时间的。

### 在二层中我们讲了ARP协议，即已知IP地址求MAC；还有一种RARP协议，即已知MAC求IP的，你知道它可以用来干什么吗？

之前有无盘工作站，即没有硬盘的机器，无法持久化ip地址到本地，但有网卡，所以可以用RARP协议来获取IP地址。RARP可以用于局域网管理员想指定机器IP（与机器绑定，不可变），又不想每台机器去设置静态IP的情况，可以在RARP服务器上配置MAC和IP对应的ARP表，不过获取每台机器的MAC地址，好像也挺麻烦的。这个协议现在应该用得不多了吧，都用BOOTP或者DHCP了。 

### 如果一个局域网里面有多个交换机，ARP广播的模式会出现什么问题呢？

ARP广播时，交换机会将一个端口收到的包转发到其它所有的端口上。
比如数据包经过交换机A到达交换机B，交换机B又将包复制为多份广播出去。
如果整个局域网存在一个环路，使得数据包又重新回到了最开始的交换机A，这个包又会被A再次复制多份广播出去。
如此循环，数据包会不停得转发，而且越来越多，最终占满带宽，或者使解析协议的硬件过载，行成广播风暴。 

## 第 6 讲 | 交换机与 VLAN：办公室太复杂，我要回学校

上一节只有几台电脑，场景比较简单，这一次切换到办公室。

### 拓扑结构是怎么形成的？

比如我们常见到的办公室大多是一排排的桌子，每个桌子都有网口，一排十几个座位就有十几个网口，一个楼层就会有几十个升至上百个网口。如果算上所有楼层，这个场景就比宿舍复杂很多了，这个时候一个交换机肯定不够用，需要多台交换机，交换机之间连起来，就形成一个稍微复杂的拓扑结构。

下图所示的便是一个拓扑结构：

![拓扑结构图](/media/book_abstract/16.jpg)

在这个拓扑结构图中，如果机器 1 想找机器 4，于是机器 1 发起广播，机器 2 收到这个广播，但是这不是找它的，所以没他什么事儿。交换机 A 一开始是不知道任何拓扑信息的，在它收到这个广播后，采取的策略是除了广播包来的方向外，它要转发 给其他所有的网口。于是机器 3 也收到了广播信息，但是这和它也没什么关系。当然，交换机 B 也是能够收到广播信息的，但是这时候它也是不知道任何拓扑信息的，因而也是进行广播的策略，将包转发到局域网三。这个时候机器 4 和机器 5 都收到了广播信息。机器 4 主动相应说，这是找我的，这是我的 MAC 地址，于是一个 ARP 请求就成功完成了。

完成之后，交换机 A 就会记住机器 1 的位置，将来如果有包传过来找机器 A，交换机 A 就会直接将包发过去。

### 如何解决常见的环路问题？

这样看来，两台交换机工作的挺好。但是随着办公室越来越大，交换机树木肯定越来越多，当整个拓扑结构复杂了，这么多网线，绕过来绕过去，不可避免的会出现意料不到的情况，其中常见的问题就是环路问题。

![环路问题](/media/book_abstract/17.jpg)

(以下全部摘自原文，写得太好了)

我们来想象一下机器 1 访问机器 2 的过程。一开始，机器 1 并不知道机器 2 的 MAC 地址，所以它需要发起一个 ARP 的广播。广播到达机器 2，机器 2 会把 MAC 地址返回来，看起来没有这两个交换机什么事情。

但是问题来了，这两个交换机还是都能够收到广播包的。交换机 A 一开始是不知道机器 2 在哪个局域网的，所以它会把广播消息放到局域网二，在局域网二广播的时候，交换机 B 右边这个网口也是能够收到广播消息的。交换机 B 会将这个广播息信息发送到局域网一。局域网一的这个广播消息，又会到达交换机 A 左边的这个接口。交换机 A 这个时候还是不知道机器 2 在哪个局域网，于是将广播包又转发到局域网二。左转左转左转，好像是个圈哦。

可能有人会说，当两台交换机都能够逐渐学习到拓扑结构之后，是不是就可以了？

别想了，压根儿学不会的。机器 1 的广播包到达交换机 A 和交换机 B 的时候，本来两个交换机都学会了机器 1 是在局域网一的，但是当交换机 A 将包广播到局域网二之后，交换机 B 右边的网口收到了来自交换机A的广播包。根据学习机制，这彻底损坏了交换机 B 的三观，刚才机器 1 还在左边的网口呢，怎么又出现在右边的网口呢？哦，那肯定是机器 1 换位置了，于是就误会了，交换机 B 就学会了，机器 1 是从右边这个网口来的，把刚才学习的那一条清理掉。同理，交换机 A 右边的网口，也能收到交换机 B 转发过来的广播包，同样也误会了，于是也学会了，机器 1 从右边的网口来，不是从左边的网口来。

然而当广播包从左边的局域网一广播的时候，两个交换机再次刷新三观，原来机器1是在左边的，过一会儿，又发现不对，是在右边的，过一会，又发现不对，是在左边的。

这还是一个包转来转去，每台机器都会发广播包，交换机转发也会复制广播包，当广播包越来越多的时候，按照上一节讲过一个共享道路的算法，也就是路会越来越堵，最后谁也别想走。所以，必须有一个方法解决环路的问题，怎么破除环路呢？

### STP 协议中那些难以理解的概念

下图所示便是一颗最小生成树

![网络拓扑图](/media/book_abstract/18.jpg)

1. Root Bridge：根交换机
2. Designated Bridges：指定交换机，比根交换机级别低的交换机都叫这个
3. Bridge Protocol Data Units（BPDU）：网桥协议数据单元，这个协议只有根交换机能发，用于比较谁有资格当根交换机用的。
4. Priority Vector：优先级向量，值越小越厉害，他就是一组 ID 数，[Root Bridge ID, Root Path Cost, Bridge ID, and Port ID]，在比较的时候先比较 Root Bridge ID，如果相同再比较 Root Path Cost，直到比出结果
   - Root Bridge ID：根交换机 ID
   - Root Path Cost：当前交换机到根的距离
   - Bridge ID：当前交换机的 ID
   - Port ID：（不知道是什么）

### STP 的工作过程是怎样的？

以下是一个图的结构，每个节点开始的时候都是 Root Bridge ID，然后相互发 BPDU，通过 BPDU 比较，数值大的则降级为 Bridge ID，最终形成一颗最小生成树。

![最小生成树](/media/book_abstract/19.jpg)

### 如何解决广播问题和安全问题

上面的问题解决了人多了联网的问题，但是如果现实里面财务和程序员在一个网段，那么这些数据包在里面那么转发，程序员要是会抓包，一抓，一看，财务的小秘密就全曝光了，所以这时候就需要考虑安全问题。

方法分为两种 

#### 物理隔离

部门内部布置交换机，布置单独的子网，部门之间布置路由器

#### 虚拟隔离

这种方式同城称为 VLAN，通过在二层头里面加一个 TAG，里面有一个 VLAN ID，一共 12 位，12 位可以划分 4096 个 VLAN，但是现在云计算厂商里面绝对不止 4096 个用户，当然每个用户需要一个 VLAN，这个问题怎么解决后面再讲。如果买的交换机支持 VLAN，那么只需要把二层头取下来，就能识别这个 VLAN ID，这样只有相同 VLAN 的包，才会相互转发，不同 VLAN 的包，是看不到的，这样广播安全的问题就解决了。

![包含 VLAN 的二层头](/media/book_abstract/20.jpg)

那么两个交换机之间怎么识别 VLAN 呢，这是由于这种交换机有个 Trunk 口，它会转发任何 VLAN 的口，交换机之间可以通过这种口相互连接。

![Trunk 口连接的交换机](/media/book_abstract/21.jpg)

这样，办公室的网络问题也就解决了

### STP 协议能够很好的解决环路问题，但是也有它的缺点，你能举几个例子吗？

STP 对于跨地域甚至跨国组织的网络支持，就很难做了，计算量太大

### 在一个比较大的网络中，如果两台机器不通，你知道应该用什么方式调试吗？

ping 加抓包工具，如 wireshark 

## 第 7 讲 | ICMP 与 ping：投石问路的侦察兵

ping 是基于 ICMP 协议工作的

### 7.1 ICMP 协议的格式

ICMP 全称 Internet Control Message Protocol（互联网控制报文协议）

ICMP 报文是封装在 IP 包里面的，下图所示为 ICMP 报文格式

![ICMP 报文格式](/media/book_abstract/22.png)

不同类型的报文是由类型字段和代码字段来共同决定。下表是各种类型的 ICMP 报文。

![ICMP 报文类型](/media/book_abstract/23.png)

由上表可知 ICMP 协议大致分为两类，一种是查询报文，另一种是差错报文。

#### 7.1.1 查询报文

查询报文是用一对请求和应答定义的，它通常由以下几种用途：

1. ping 查询
2. 子网掩码查询（用于无盘工作站在初始化自身的时候初始化子网掩码）
3. 时间戳查询（可以用来同步时间）

#### 7.1.2 差错报文

当传送 IP 数据包发生错误时，比如主机不可达、端口不可达等，ICMP 协议就会把错误信息封包，然后传送给主机。

### 7.2 ping 数据包格式

![ping 数据包格式](/media/book_abstract/24.png)

### 7.3 TTL 的作用

TTL 是网络包里的一个值，它告诉路由器包在网络钟中太长时间是否需要被丢弃。TTL 最初的设想是，设置超过时间，超过此范围则被丢弃。每个路由器要将 TTL 减一，TTL 通常表示被丢弃前经过的路由器的个数。当 TTL 变为 0 时，该路由器丢弃该包，并发送一个 ICMP 包给最初的发送者。tranceroute 差错报文会使用。

## 第 8 讲 | 世界这么大，我想出网关：欧洲十国游与玄奘西行

## 第 9 讲 | 路由协议：西出网关无故人，敢问路在何方

# 参考资料

1. [趣谈网络协议](https://time.geekbang.org/column/intro/85)
2. [HCNP 学习笔记之 ICMP 协议与 ping 原理以及用 Python 实现 ping](https://www.cnblogs.com/JetpropelledSnake/p/9177770.html)


