---
title: "阿里巴巴中间件招聘"
date: 2020-08-16T20:21:00+08:00
keywords: []
description: ""
tags: [

]
categories: [
    "杂货铺"
]
autoCollapseToc: false
author: "yuanzx"
draft: true
---

# 你们系统中用到了分布式锁，能说一下这一块的用法么

由于这是一个分布式的系统，设计的时候是为每一台设备配备一个全系统唯一的数据处理器去处理设备传输过来的数据。所以在开启数据处理器的时候需要判断当前是否有正在运行的数据处理器，这一步的判断用到了分布式锁。

主流分布式锁的实现方式有三种，分别是基于数据库、基于缓存和基于 zookeeper 的实现方式，在系统中选择使用缓存的方式来实现分布式锁，主要是因为系统中已经引入了 redis 作为缓存，并且 redis 是使用阿里提供的服务来保证高可用。没有使用 zookeeper 是因为使用数据库实现的分布式锁性能和 zookeeper 差不多，而系统中本身没有使用 zookeeper，如果增加 zookeeper 还需要考虑 zookeeper 的维护问题所以没有采用 zookeeper 来作为临时方案，而使用数据库来实现没有缓存的效率高。

这里使用 redis 实现分布式锁，在每次受到开启数据处理器的通知后去开启数据处理器，通过 setex 命令设置一个 key-value 键值并加上过期时间，设置的 key 是设备的标识，value 是处理器的唯一标识，这个标识是在启动设备处理器时生成的 UUID，在处理器处理数据之前获取 redis 中存储的处理器的 UUID，然后和内存中缓存的 UUID 做比较，如果不是内存中缓存的 UUID 则说明当前的设备处理器不是最新的，则将当前处理器结束掉。如果是当前的处理器那么则重新设置过期时间。

# 为什么不能是多处理器去处理数据呢

由于传输过来的数据是连续的心电波形数据，数据需要保持它的连续性，对于单处理器的情况，处理器在处理好之后将数据发送到 MQTT 的代理上面，然后由消费者进行消费，整个流程可以很好的维持数据的连续性，如果改成多处理器处理的情况，那么可能会出现某些时间较晚的数据较早处理好并发送到 MQTT，那么数据的连续性就乱掉了，消费端在消费的时候便会出现问题。如果专门为了解决这个连续性的问题去实现一个服务做处理，会增大系统的复杂度和维护难度。而单处理器在使用性能上也没有问题，所以没有必要改成使用多处理器的情况。

# 如果说 redis 哪怕有高可用，但是挂了那系统怎么办

首先系统保证了 redis 是高可用的，但是如果 redis 挂了，接收器在接收到数据后无法将数据放入 redis 队列，那么便会将数据暂时缓存到本地系统文件中，等 redis 恢复正常再从本地文件中读取数据写入到 redis 中，确保数据不会丢失。