---
title: "TCP：首部结构"
date: 2019-07-12T15:05:42+08:00
keywords: []
description: ""
tags: [
    "TCP","网络"
]
categories: [
    "杂货铺"
]
autoCollapseToc: false
author: "yuanzx"
markup: mmark
mathjax: true  
---

# 一、TCP 数据在 IP 数据报中的封装

![TCP 数据在 IP 数据报中的封装](/media/hovel/9.png)

# 二、TCP 首部的数据格式

![TCP 首部的数据格式](/media/hovel/10.png)

TCP 首部的数据结构，如果不计选项字段，首部是 20 个字节。

## 2.1 序号 32 位

序号是 32 位无符号数，序号范围从 0 到 $$2^{32} - 1$$，当需要达到 $$2^{32} - 1$$ 之后会从 0 开始。

## 2.2 确认序号 32 位

确认序号为上次成功接收的序号 + 1，只有在 ACK 标志为 1 时，确认序号字段才有效。

## 2.3 首部长度 4 位

首部长度 4 位，单位为 4 字节，首部的最大长度为 $$15 * 4 = 60$$ 字节，其中首部的固定长度为 20 字节，选项的最大长度为 40 字节。

## 2.4 保留位 6 位

暂时没有作用，全部置为 0。关于这里的保留位为什么不放到选项中，我的理解是如果放到选项中，那么只要别人使用了选项位，那么就没法平滑升级到更新过后的 TCP 协议，因为选项位在不同的场景下可能有不同的含义。

## 2.5 六个标志位

### 2.5.1 URG

当 URG = 1 时，表示有紧急指针有效。

### 2.5.2 ACK

当 ACK = 1 时，确认序号字段才有效。当 ACK = 0 时，确认序号字段无效。TCP 规定，在连接建立后所有传输的报文段都必须把 ACK 置 1。

### 2.5.3 PSH

当 PSH = 1 时，接收方应该尽快将这个报文段交给应用层，而不会等整个缓存填满后再交付。

### 2.5.4 RST

当 RST = 1 时，表示连接有差错，需要重新建立连接。

### 2.5.5 SYN

在建立连接时使用，当 SYN = 1，ACK = 0 时，表示这是一个请求连接的报文段。若对方统一建立连接，则在响应报文段中使得 SYN = 1，ACK = 1。

### 2.5.6 FIN

用来释放一个连接，当 FIN = 1，表示此报文段发送方的数据发送完毕，并要求释放连接。

## 2.6 窗口大小 16 位

窗口大小指的是发送这个报文的一端一次性能够接收的字节数。
// todo 比如传输 2 个字节，就是只能接收两个字节么？这个接收的单位是什么，每一个 TCP 报文么？如果是的话，那么这个窗口大小传到对面之后，那么下次来的报文的数据字节数不就是小于等于这个字节数了么？

## 2.7 校验和 16 位

校验和的计算包含首部和数据这两个部分，计算校验和的时候要在 TCP 报文段的时候要在前面加上 12 字节的伪首部。
// todo 
    1. 加的这 12 个字节的伪首部是什么东西？
    2. 这个伪首部和 UDP 的位首部是什么关系？

## 2.8 紧急指针 16 位

当 URG = 1 时，紧急指针才有效，指出本报文段中的紧急数据的字节数。当窗口大小为 0 时，依然可以发送紧急数据。

# 参考资料

1. [TCP-IP 详解：第17 章TCP ：传输控制协议](https://gitee.com/zhixiangyuan/bookStorage/raw/master/%E7%BC%96%E7%A8%8B/TCP-IP%E8%AF%A6%E8%A7%A3(%E5%8D%B7%E4%B8%80%E3%80%81%E4%BA%8C%E3%80%81%E4%B8%89).pdf)
2. [详解 TCP 和 UDP 数据段的首部格式](https://www.cnblogs.com/winner-0715/p/5032738.html)